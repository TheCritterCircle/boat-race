class Component{constructor(e){this.gameObject={worldX:0,worldY:0},e&&(this.gameObject=e)}}class Game{constructor(e,i,s){this.stage=new createjs.Stage(e),this.stage.canvas.width=i,this.stage.canvas.height=s,createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",this.update.bind(this)),this.room=new Room(this),this.stage.addChild(this.room),this.hud=new HUD(this),this.stage.addChild(this.hud),this.shipInfo={},window.onkeydown=this.bindEvent("inputDown"),window.onkeyup=this.bindEvent("inputUp"),this.stage.on("stagemousemove",this.bindEvent("mouseMove")),this.stage.on("stagemousedown",this.bindEvent("mouseClick"))}bindEvent(e){return this[e].bind(this)}getSize(){return{w:this.stage.canvas.width,h:this.stage.canvas.height}}emit(...e){this.socket&&this.socket.emit(...e)}on(...e){this.socket&&this.socket.on(...e)}join(e){var i=io(e);this.socket=i,i.on("connect",(function(){console.log("Connected to server")}));var s=this.room;s.bind("joinShip"),s.bind("addShip"),s.bind("removeShip"),i.on("pending",s.bind("reset",!0)),s.bind("raceStart"),s.bind("moveShip"),s.bind("moveCrosshair")}update(e){this.stage.canvas.width=window.innerWidth,this.stage.canvas.height=window.innerHeight,this.player&&this.room.update(),this.hud.update(),this.stage.update()}mouseClick(e){this.fire()}fire(){this.room.fire(this.player.getCrumb(!0)),this.emit("fire",this.player.getCrumb(!0))}mouseMove(e){!this.player||1!=this.player.mode&&-1!=this.player.mode||(this.player.setCrosshairPos(e.stageX,e.stageY),this.emit("moveCrosshair",this.player.getCrosshairPos()))}inputDown(e){if(this.player&&(0==this.player.mode||-1==this.player.mode)){switch(console.log("INPUT: "+e.keyCode),e.keyCode){case 38:case 87:this.player.moving.up=1;break;case 37:case 65:this.player.moving.left=1;break;case 40:case 83:this.player.moving.down=1;break;case 39:case 68:this.player.moving.right=1}var{up:i,down:s,left:t,right:a}=this.player.moving;0==i&&0==s&&0==t&&0==a||this.emit("moveShip",{x:this.player.worldX,y:this.player.worldY,moving:this.player.moving})}}inputUp(e){if(this.player)switch(console.log("INPUT: "+e.keyCode),e.keyCode){case 38:case 87:this.player.moving.up=0,this.emit("moveShip",{x:this.player.x,y:this.player.y,moving:this.player.moving});break;case 37:case 65:this.player.moving.left=0,this.emit("moveShip",{x:this.player.x,y:this.player.y,moving:this.player.moving});break;case 40:case 83:this.player.moving.down=0,this.emit("moveShip",{x:this.player.x,y:this.player.y,moving:this.player.moving});break;case 39:case 68:this.player.moving.right=0,this.emit("moveShip",{x:this.player.x,y:this.player.y,moving:this.player.moving})}}}class GameObject extends createjs.Container{constructor(e,i=0,s=0){super(),this.x=i,this.y=s}update(){}setPos(e,i){this.x=e,this.y=i}getPos(){return{x:this.x,y:this.y}}destroy(){this.parent.removeChild(this)}}class HUD extends createjs.Container{constructor(e){super(),this.starting=new createjs.Container,this.addChild(this.starting),this.text=new createjs.Text("Waiting for 1 more player","bold 50px Arial","#ffffff"),this.starting.addChild(this.text),this.outline=new createjs.Text("Waiting for 1 more player","bold 50px Arial","#000"),this.starting.addChild(this.outline),this.outline.outline=3,this.minimap=new Minimap(e),this.addChild(this.minimap),this.pointermap=new Pointermap(e),this.addChild(this.pointermap)}splash(e){}update(){this.minimap.update(),this.pointermap.update()}}class Room extends createjs.Container{constructor(e){super(),this.background=new createjs.Bitmap("media/background.png"),this.addChild(this.background),this.size={w:1920,h:5550};var i=e.getSize();this.startY=this.size.h-i.h/2,this.ships={},this.setBounds(0,0,this.size.w,this.size.h),this.cannonballs=[]}bind(e,i){if(i)return this[e].bind(this);game.on(e,this[e].bind(this))}update(){Object.values(this.ships).forEach(e=>{e.update()}),this.cannonballs.forEach(e=>{e.update()});var e=game.getSize(),i=game.player.getPos();this.x=e.w/2-i.x,this.y=e.h/2-i.y;var s=e.h-this.size.h,t=e.w-this.size.w;this.y<s?this.y=s:this.y>0&&(this.y=0),this.x<t?this.x=t:this.x>-t&&(this.x=-t)}reset(){game.hud.starting.visible=!0,console.log("We be finding you a crew..."),this.player=void 0,Object.values(this.ships).forEach(e=>{e.destroy()}),this.ships={},this.shipInfo={}}fire(e){var i=new CannonBall(game,game.room.ships[e.name]);this.addChild(i),this.cannonballs.push(i),this.cannonballs.length>5&&this.removeCannonball(this.cannonballs[0])}removeCannonball(e){var i=this.cannonballs.indexOf(e);i>-1&&(e.destroy(),this.cannonballs.splice(i,1))}joinShip(e){for(var i in game.hud.starting.visible=!1,console.log("joinShip",e),console.log("You are the",(0==e.mode?"Captain":"Cannon")+"!"),game.shipInfo.name=e.name,game.shipInfo.mode=e.mode,e.ships)this.addShip(e.ships[i])}moveShip(e){console.log("moveShip",e),e.name==game.player.name&&0==game.player.mode||this.ships[e.name].updateCrumb(e)}raceStart(){console.log("Race Start")}moveCrosshair(e){console.log("moveCrosshair",e),this.ships[e.name].updateCrumb(e)}addShip(e){if(!this.ships[e.name]){console.log("addShip",e);var i=new Player(this,e.name);i.updateCrumb(e),this.ships[i.name]=i,i.name==game.shipInfo.name&&(i.mode=game.shipInfo.mode,console.log(0==game.shipInfo.mode?i.cannon+": Aye Aye Captain!":i.captain+": Ahoy Mateys!"),game.player=i),this.addChild(i)}}removeShip(e){console.log("removeShip",e),this.ships[e.name]&&(this.ships[e.name].destroy(),delete this.ships[e.name])}}class UIMap extends createjs.Container{constructor(e){super(),this.nodes=new createjs.Container,this.addChild(this.nodes)}newNode(e,i,s,t,...a){var h=2/(this.scaleX+this.scaleY),n=this.createNodeShape(t*h,s,...a);this.nodes.addChild(n),n.x=e,n.y=i}setScale(e){this.scaleX=e*game.getSize().h/game.room.size.h,this.scaleY=e*game.getSize().h/game.room.size.h}setPos(e,i){this.x=e*(game.getSize().w-this.scaleX*game.room.size.w),this.y=i*(game.getSize().h-this.scaleY*game.room.size.h)}update(){this.nodes.removeAllChildren(),Object.values(game.room.ships).map(e=>e.getCrumb(!0)).forEach(e=>{this.mapPlayer(e)})}mapPlayer(e){this.newNode(e.x,e.y,"black")}createNodeShape(e,i,...s){var t=new createjs.Shape;return t.graphics.beginFill(i).drawCircle(0,0,e),t}}const ZERO_VECTOR={x:0,y:0};DEBUG=!0;var oldLog=console.log;function lerpXY(e,i,s){return{x:e.x+s*(i.x-e.x),y:e.y+s*(i.y-e.y)}}function generateCoins(e,i){var s=[];for(let t=0;t<e;t++)s.push(Math.random()*i.x),s.push(Math.random()*i.y);return s}function centerText(e){var i=e.getBounds();e.x+=-i.width/2}function vec(...e){return 1==e.length?"object"==typeof e[0]?Object.values(e[0]):e[0]:e}function mag2(...e){return(e=vec(...e)).reduce((e,i)=>e+i*i,0)}function mag(...e){return Math.sqrt(mag2(...e))}function norm(...e){e=vec(...e);var i=mag(...e);return e.map(e=>e/i)}function collided(e,i){var s=e.getBounds(),t=i.getBounds();return!(s.x>=t.x+t.width||s.x+s.width<=t.x||s.y>=t.y+t.height||s.y+s.height<=t.y)}console.log=(...e)=>{DEBUG&&oldLog(...e)};class PhysicsBody extends Component{constructor(e){super(e),this.velocity={x:0,y:0},this.dampening=.035}update(){this.gameObject.x+=this.velocity.x,this.gameObject.y+=this.velocity.y,this.velocity=lerpXY(this.velocity,ZERO_VECTOR,this.dampening)}addImpulse(e,i){this.velocity.x+=e,this.velocity.y+=i}}class CannonBall extends GameObject{constructor(e,i){super(e,...Object.values(i.getPos())),this.cannonBallGraphic=new createjs.Shape,this.addChild(this.cannonBallGraphic),this.cannonBallGraphic.graphics.beginFill("black").drawCircle(0,0,20);var s=i.crosshair.localToLocal(0,0,e.room),t=norm({x:s.x-i.x,y:s.y-i.y});this.dir={x:t[0],y:t[1]}}update(){this.x+=15*this.dir.x,this.y+=15*this.dir.y,this.setBounds(this.x,this.y,20,20),collided(this,game.room)||game.room.removeCannonball(this)}}class Coin extends GameObject{constructor(e,i,s){super(e,i,s),this.coinGraphic=new createjs.Shape,this.coinGraphic.graphics.beginFill("Yellow").drawCircle(0,0,25),this.addChild(this.coinGraphic)}}class Player extends GameObject{constructor(e,i,s=0,t=0){super(e,s,t),this.name=i,this.mode=-1,this.speed=.3,this.moving={up:0,down:0,left:0,right:0},this.ship=new createjs.Container,this.addChild(this.ship),this.shipGraphic=new createjs.Shape,this.ship.addChild(this.shipGraphic),this.shipGraphic.graphics.beginFill("DeepSkyBlue").drawCircle(0,0,50),this.captainNickname=new createjs.Text("Captain","15px Arial","#000000"),this.ship.addChild(this.captainNickname),this.captainNickname.y=50,centerText(this.captainNickname),this.crosshair=new createjs.Container,this.addChild(this.crosshair),this.crosshairGraphic=new createjs.Shape,this.crosshairGraphic.graphics.beginFill("Green").drawCircle(0,0,20),this.crosshair.addChild(this.crosshairGraphic),this.cannonNickname=new createjs.Text("Cannon","15px Arial","#000000"),this.crosshair.addChild(this.cannonNickname),this.cannonNickname.y=20,centerText(this.cannonNickname),this.physics=new PhysicsBody(this.ship)}update(){this.physics.addImpulse((this.moving.right-this.moving.left)*this.speed,(this.moving.down/2-this.moving.up)*this.speed),1!=this.mode&&-1!=this.mode||this.setCrosshairPos(game.stage.mouseX,game.stage.mouseY),this.physics.update(),this.y+=this.ship.y,this.ship.y=0,this.x+=this.ship.x,this.ship.x=0}getPos(){return this.ship.localToLocal(0,0,game.room)}setCrosshairPos(e,i){var s=this.globalToLocal(e,i);this.crosshair.x=s.x,this.crosshair.y=s.y}getCrosshairPos(){return this.crosshair.localToGlobal(0,0)}getCrumb(e){if(e)return{name:this.name,x:this.getPos().x,y:this.getPos().y,moving:this.moving,crosshair:this.getCrosshairPos()};switch(this.mode){case 0:return{name:this.name,mode:this.mode,x:this.getPos().x,y:this.getPos().y,moving:this.moving};case 1:return{name:this.name,mode:this.mode,crosshair:this.getCrosshairPos()};default:return{name:this.name,mode:this.mode,x:this.getPos().x,y:this.getPos().y,moving:this.moving,crosshair:this.getCrosshairPos()}}}updateCrumb(e){e.mode&&(this.mode=e.mode),e.name&&(this.name=e.name),e.captain&&(this.captainNickname.text=this.captain=e.captain)&&centerText(this.captainNickname),e.cannon&&(this.cannonNickname.text=this.cannon=e.cannon)&&centerText(this.cannonNickname),e.x&&e.y&&this.setPos(e.x,e.y),e.moving&&(this.moving=e.moving),e.crosshair&&this.setCrosshairPos(e.crosshair.x,e.crosshair.y)}}class Minimap extends UIMap{constructor(e){super(e),this.box=new createjs.Shape,this.addChild(this.box),this.box.graphics.beginFill("rgba(222,222,222,.7)").drawRect(0,0,e.room.size.w,e.room.size.h),this.setChildIndex(this.box,0)}update(){super.update(),this.setScale(.4),this.setPos(.99,.02)}mapPlayer(e){this.newNode(e.x,e.y,"magenta",10)}}class Pointermap extends UIMap{constructor(e){super(e)}mapPlayer(e){var i=game.getSize(),s=game.room.localToGlobal(e.x,e.y),t=s.y,a=s.x,h=0;(t>i.h||t<0||a>i.w||a<0)&&(h=20),a>i.w&&(a=i.w-30),a<0&&(a=30),t<0&&(t=i.h-30,n=1),t>i.h&&(t=30);var n=180*Math.atan2(s.y-t,s.x-a)/Math.PI;this.newNode(a,t,"magenta",h,e.name,n)}createNodeShape(e,i,s,t){var a=new createjs.Container,h=new createjs.Shape;a.addChild(h),h.graphics.beginFill(i).drawPolyStar(0,0,e,3,0,t);var n=s||"Player",o=new createjs.Text(n,"bold 20px Arial","#ffffff");a.addChild(o),centerText(o);var r=new createjs.Text(n,"bold 20px Arial","#000");return a.addChild(r),centerText(r),r.outline=1.1,a}}
//# sourceMappingURL=game.min.js.map
